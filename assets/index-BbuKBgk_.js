var Et=Object.defineProperty;var At=(z,t,r)=>t in z?Et(z,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):z[t]=r;var bt=(z,t,r)=>At(z,typeof t!="symbol"?t+"":t,r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const h of a.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function r(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=r(o);fetch(o.href,a)}})();class Rt{constructor(t){this.canvas=t,this.initWebGL()}initWebGL(){if(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.gl=this.canvas.getContext("webgl2"),!this.gl)throw new Error("WebGL 2.0 is not supported in your browser.");this.gl.clearColor(0,0,0,1),this.clear(),this.gl.enable(this.gl.BLEND),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA)}resizeCanvas(){const t=window.devicePixelRatio||1,r=this.canvas.clientWidth,s=this.canvas.clientHeight;(this.canvas.width!==r*t||this.canvas.height!==s*t)&&(this.canvas.width=r*t,this.canvas.height=s*t,this.gl.viewport(0,0,this.canvas.width,this.canvas.height))}createProjectionMatrix(t,r,s){const o=this.canvas.width/this.canvas.height,a=1/s;return new Float32Array([a/o,0,0,0,0,a,0,0,0,0,1,0,-t*a/o,-r*a,0,1])}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)}}class xt{constructor(t){this.gl=t,this.program=null,this.locations={}}createShader(t,r){const s=this.gl.createShader(t);return this.gl.shaderSource(s,r),this.gl.compileShader(s),s}createProgram(t,r){const s=this.createShader(this.gl.VERTEX_SHADER,t),o=this.createShader(this.gl.FRAGMENT_SHADER,r),a=this.gl.createProgram();return this.gl.attachShader(a,s),this.gl.attachShader(a,o),this.gl.linkProgram(a),this.gl.deleteShader(s),this.gl.deleteShader(o),a}}class St extends xt{constructor(t){super(t),this.numCircles=0,this.offsets=null,this.sizes=null,this.colors=null,this.titles=null,this.ids=null,this.vao=null,this.buffers={position:null,offset:null,size:null,color:null},this.initShaders()}initShaders(){const t=`#version 300 es
      in vec2 a_position;    
      in vec2 a_offset;     
      in float a_size;
      in vec4 a_color;       
      uniform mat4 u_projection;   
      uniform float cameraDistance;
      out vec2 v_point;    
      out vec4 v_color;     

      void main() {
        vec2 scaledPosition = a_position * (a_size + cameraDistance) + a_offset;
        gl_Position = u_projection * vec4(scaledPosition, 0.0, 1.0);
        v_point = a_position; // we give the position so it can be interpolated and we can use it to discard fragments outside the circle
        v_color = a_color; 
      }
    `,r=`#version 300 es
      precision highp float;
      in vec2 v_point;         
      in vec4 v_color; 
      out vec4 fragColor;
      
      void main() {
        float dist = length(v_point); 
        if (dist > 1.0) discard;     
        
        // Mix the color with white to make it more pastel
        vec3 pastelColor = mix(v_color.rgb, vec3(1.0), 0.3); 
        fragColor = vec4(pastelColor, v_color.a);
      }
    `;this.program=this.createProgram(t,r),this.locations={position:this.gl.getAttribLocation(this.program,"a_position"),offset:this.gl.getAttribLocation(this.program,"a_offset"),size:this.gl.getAttribLocation(this.program,"a_size"),color:this.gl.getAttribLocation(this.program,"a_color"),projection:this.gl.getUniformLocation(this.program,"u_projection"),cameraDistance:this.gl.getUniformLocation(this.program,"cameraDistance")}}setData(t){this.numCircles=t.numItems,this.offsets=t.offsets,this.sizes=t.sizes,this.colors=t.colors,this.titles=t.titles,this.ids=t.ids,this.initBuffers()}initBuffers(){const t=this.gl;this.clean(),this.vao=t.createVertexArray(),t.bindVertexArray(this.vao);const r=new Float32Array([-1,-1,1,-1,-1,1,1,-1,1,1,-1,1]);this.buffers.position=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.position),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),t.enableVertexAttribArray(this.locations.position),t.vertexAttribPointer(this.locations.position,2,t.FLOAT,!1,0,0),t.vertexAttribDivisor(this.locations.position,0),this.buffers.offset=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.offset),t.bufferData(t.ARRAY_BUFFER,this.offsets,t.DYNAMIC_DRAW),t.enableVertexAttribArray(this.locations.offset),t.vertexAttribPointer(this.locations.offset,2,t.FLOAT,!1,0,0),t.vertexAttribDivisor(this.locations.offset,1),this.buffers.size=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.size),t.bufferData(t.ARRAY_BUFFER,this.sizes,t.DYNAMIC_DRAW),t.enableVertexAttribArray(this.locations.size),t.vertexAttribPointer(this.locations.size,1,t.FLOAT,!1,0,0),t.vertexAttribDivisor(this.locations.size,1),this.buffers.color=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.color),t.bufferData(t.ARRAY_BUFFER,this.colors,t.DYNAMIC_DRAW),t.enableVertexAttribArray(this.locations.color),t.vertexAttribPointer(this.locations.color,4,t.FLOAT,!1,0,0),t.vertexAttribDivisor(this.locations.color,1),t.bindVertexArray(null)}draw(t,r){const s=this.gl;s.useProgram(this.program),s.bindVertexArray(this.vao),s.uniformMatrix4fv(this.locations.projection,!1,t),s.uniform1f(this.locations.cameraDistance,r*6e-4),s.drawArraysInstanced(s.TRIANGLES,0,6,this.numCircles)}clean(){const t=this.gl;this.vao&&(t.deleteVertexArray(this.vao),this.vao=null),this.buffers.position&&(t.deleteBuffer(this.buffers.position),this.buffers.position=null),this.buffers.offset&&(t.deleteBuffer(this.buffers.offset),this.buffers.offset=null),this.buffers.size&&(t.deleteBuffer(this.buffers.size),this.buffers.size=null),this.buffers.color&&(t.deleteBuffer(this.buffers.color),this.buffers.color=null)}}class Tt extends xt{constructor(t){super(t),this.fontInfo=null,this.characterCount=0,this.positions=null,this.charSizes=null,this.texturePositions=null,this.vao=null,this.texture=null,this.buffers={point:null,position:null,charSize:null,texturePosition:null},this.initShaders()}initShaders(){const t=`#version 300 es
      precision highp float;
      
      uniform mat4 modelViewProjection;
      uniform vec4 color;
      uniform vec2 viewportSize;
  
      in vec3 position;
      in vec2 point;
      in vec2 charSize;
      in vec4 texturePosition;
  
      out vec2 vPoint;
      out vec4 vColor;
  
      void main() {
        
        vec3 pos = position + vec3(vec2(point) * charSize.xy, 0.0);
        gl_Position = modelViewProjection * vec4(pos, 1.0);
        vPoint = texturePosition.xy + point * texturePosition.zw;
        vColor = color;
      }`,r=`#version 300 es
      precision highp float;
      
      uniform sampler2D msdf;
      uniform float bias;
  
      in vec2 vPoint;
      in vec4 vColor;
  
      out vec4 fragColor;
  
      float median(float r, float g, float b) {
        return max(min(r, g), min(max(r, g), b));
      }
  
      void main() {
 
        if (vColor.a <= 0.0) {
          discard;
          return;
        }
        
        vec3 saple = texture(msdf, vPoint).rgb;
        float sigDist = median(saple.r, saple.g, saple.b) - bias;

        float alpha = clamp(sigDist / fwidth(sigDist) + bias, 0.0, 1.0);

        fragColor = vec4(vColor.rgb, vColor.a * alpha);
        
        if (fragColor.a < 0.01) discard;
      }`;if(this.program=this.createProgram(t,r),!this.program){console.error("Failed to create shader program for text renderer");return}this.locations={position:this.gl.getAttribLocation(this.program,"position"),point:this.gl.getAttribLocation(this.program,"point"),charSize:this.gl.getAttribLocation(this.program,"charSize"),texturePosition:this.gl.getAttribLocation(this.program,"texturePosition"),modelViewProjection:this.gl.getUniformLocation(this.program,"modelViewProjection"),color:this.gl.getUniformLocation(this.program,"color"),bias:this.gl.getUniformLocation(this.program,"bias"),msdf:this.gl.getUniformLocation(this.program,"msdf")}}initBuffers(){const t=this.gl;this.clean(),this.vao=t.createVertexArray(),t.bindVertexArray(this.vao);const r=new Float32Array([0,0,1,0,1,1,1,1,0,0,0,1]);this.buffers.point=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.point),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),t.enableVertexAttribArray(this.locations.point),t.vertexAttribPointer(this.locations.point,2,t.FLOAT,!1,0,0),t.vertexAttribDivisor(this.locations.point,0),this.buffers.position=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.position),t.bufferData(t.ARRAY_BUFFER,this.positions,t.DYNAMIC_DRAW),t.enableVertexAttribArray(this.locations.position),t.vertexAttribPointer(this.locations.position,3,t.FLOAT,!1,0,0),t.vertexAttribDivisor(this.locations.position,1),this.buffers.charSize=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.charSize),t.bufferData(t.ARRAY_BUFFER,this.charSizes,t.DYNAMIC_DRAW),t.enableVertexAttribArray(this.locations.charSize),t.vertexAttribPointer(this.locations.charSize,2,t.FLOAT,!1,0,0),t.vertexAttribDivisor(this.locations.charSize,1),this.buffers.texturePosition=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.texturePosition),t.bufferData(t.ARRAY_BUFFER,this.texturePositions,t.DYNAMIC_DRAW),t.enableVertexAttribArray(this.locations.texturePosition),t.vertexAttribPointer(this.locations.texturePosition,4,t.FLOAT,!1,0,0),t.vertexAttribDivisor(this.locations.texturePosition,1),t.bindVertexArray(null)}async loadFont(){try{const r=await(await fetch("/Map-of-Wiki/fonts/Roboto.json",{mode:"cors"})).json();return this.fontInfo=r,this.alphabet=new Map,r.chars.forEach(s=>{this.alphabet.set(String.fromCharCode(s.id),s)}),new Promise((s,o)=>{const a=new Image;a.crossOrigin="Anonymous",a.onload=()=>{const h=this.gl;this.texture&&(h.deleteTexture(this.texture),this.texture=null),this.texture=h.createTexture(),h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!0),h.bindTexture(h.TEXTURE_2D,this.texture),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,a),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),h.bindTexture(h.TEXTURE_2D,null),this.sdfTextureWidth=a.width,this.sdfTextureHeight=a.height,s()},a.onerror=()=>{o(new Error("Failed to load font texture"))},a.src="/Map-of-Wiki/fonts/Roboto0.png"})}catch(t){throw console.error("Failed to load font:",t),t}}batchAddText(t){let r=0;for(const s of t)s.text&&(r+=s.text.length);this.characterCount=0,this.positions=new Float32Array(r*3),this.charSizes=new Float32Array(r*2),this.texturePositions=new Float32Array(r*4);for(const s of t)this.addText(s);this.initBuffers()}addText(t){let{text:r,x:s=0,y:o=0,z:a=0}=t,h=0,_=t.fontSize;if(t.limit!==void 0){let l=0;for(let g of r){const R=this.alphabet.get(g)||this.alphabet.get("?");l+=R.xadvance}_=t.limit*this.fontInfo.info.size/l}const T=_/this.fontInfo.info.size;if(t.cx!==void 0){let l=0;for(const g of r){const R=this.alphabet.get(g)||this.alphabet.get("_");l+=R.xadvance}h-=l*t.cx*T}t.cy!==void 0&&(o+=_*t.cy);for(let l=0;l<r.length;l++){const g=this.characterCount+l,R=r[l],A=this.alphabet.get(R)||this.alphabet.get("_"),L=g*3;this.positions[L]=s+h,this.positions[L+1]=o-A.yoffset*T,this.positions[L+2]=a;const q=g*2;this.charSizes[q]=_*A.width/42,this.charSizes[q+1]=-_*A.height/42;const Z=g*4;this.texturePositions[Z]=A.x/this.sdfTextureWidth,this.texturePositions[Z+1]=1-A.y/this.sdfTextureHeight,this.texturePositions[Z+2]=A.width/this.sdfTextureWidth,this.texturePositions[Z+3]=-A.height/this.sdfTextureHeight,h+=A.xadvance*T}this.characterCount+=r.length}draw(t){const r=this.gl;r.useProgram(this.program),r.bindVertexArray(this.vao),r.uniformMatrix4fv(this.locations.modelViewProjection,!1,t),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.texture),r.uniform1i(this.locations.msdf,0),r.uniform4f(this.locations.color,1,1,1,1),r.uniform1f(this.locations.bias,.5),r.drawArraysInstanced(r.TRIANGLES,0,6,this.characterCount),r.bindVertexArray(null)}clean(){const t=this.gl;this.vao&&(t.deleteVertexArray(this.vao),this.vao=null),this.buffers.point&&(t.deleteBuffer(this.buffers.point),this.buffers.point=null),this.buffers.position&&(t.deleteBuffer(this.buffers.position),this.buffers.position=null),this.buffers.charSize&&(t.deleteBuffer(this.buffers.charSize),this.buffers.charSize=null),this.buffers.texturePosition&&(t.deleteBuffer(this.buffers.texturePosition),this.buffers.texturePosition=null)}}function kt(z){return z&&z.__esModule&&Object.prototype.hasOwnProperty.call(z,"default")?z.default:z}var lt={exports:{}};/* @license
Papa Parse
v5.5.3
https://github.com/mholt/PapaParse
License: MIT
*/var Dt=lt.exports,yt;function Ct(){return yt||(yt=1,function(z,t){((r,s)=>{z.exports=s()})(Dt,function r(){var s=typeof self<"u"?self:typeof window<"u"?window:s!==void 0?s:{},o,a=!s.document&&!!s.postMessage,h=s.IS_PAPA_WORKER||!1,_={},T=0,l={};function g(e){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},(function(i){var n=dt(i);n.chunkSize=parseInt(n.chunkSize),i.step||i.chunk||(n.chunkSize=null),this._handle=new Z(n),(this._handle.streamer=this)._config=n}).call(this,e),this.parseChunk=function(i,n){var u=parseInt(this._config.skipFirstNLines)||0;if(this.isFirstChunk&&0<u){let b=this._config.newline;b||(c=this._config.quoteChar||'"',b=this._handle.guessLineEndings(i,c)),i=[...i.split(b).slice(u)].join(b)}this.isFirstChunk&&D(this._config.beforeFirstChunk)&&(c=this._config.beforeFirstChunk(i))!==void 0&&(i=c),this.isFirstChunk=!1,this._halted=!1;var u=this._partialLine+i,c=(this._partialLine="",this._handle.parse(u,this._baseIndex,!this._finished));if(!this._handle.paused()&&!this._handle.aborted()){if(i=c.meta.cursor,u=(this._finished||(this._partialLine=u.substring(i-this._baseIndex),this._baseIndex=i),c&&c.data&&(this._rowCount+=c.data.length),this._finished||this._config.preview&&this._rowCount>=this._config.preview),h)s.postMessage({results:c,workerId:l.WORKER_ID,finished:u});else if(D(this._config.chunk)&&!n){if(this._config.chunk(c,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);this._completeResults=c=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(c.data),this._completeResults.errors=this._completeResults.errors.concat(c.errors),this._completeResults.meta=c.meta),this._completed||!u||!D(this._config.complete)||c&&c.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),u||c&&c.meta.paused||this._nextChunk(),c}this._halted=!0},this._sendError=function(i){D(this._config.error)?this._config.error(i):h&&this._config.error&&s.postMessage({workerId:l.WORKER_ID,error:i,finished:!1})}}function R(e){var i;(e=e||{}).chunkSize||(e.chunkSize=l.RemoteChunkSize),g.call(this,e),this._nextChunk=a?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(n){this._input=n,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(i=new XMLHttpRequest,this._config.withCredentials&&(i.withCredentials=this._config.withCredentials),a||(i.onload=it(this._chunkLoaded,this),i.onerror=it(this._chunkError,this)),i.open(this._config.downloadRequestBody?"POST":"GET",this._input,!a),this._config.downloadRequestHeaders){var n,u=this._config.downloadRequestHeaders;for(n in u)i.setRequestHeader(n,u[n])}var c;this._config.chunkSize&&(c=this._start+this._config.chunkSize-1,i.setRequestHeader("Range","bytes="+this._start+"-"+c));try{i.send(this._config.downloadRequestBody)}catch(b){this._chunkError(b.message)}a&&i.status===0&&this._chunkError()}},this._chunkLoaded=function(){i.readyState===4&&(i.status<200||400<=i.status?this._chunkError():(this._start+=this._config.chunkSize||i.responseText.length,this._finished=!this._config.chunkSize||this._start>=(n=>(n=n.getResponseHeader("Content-Range"))!==null?parseInt(n.substring(n.lastIndexOf("/")+1)):-1)(i),this.parseChunk(i.responseText)))},this._chunkError=function(n){n=i.statusText||n,this._sendError(new Error(n))}}function A(e){(e=e||{}).chunkSize||(e.chunkSize=l.LocalChunkSize),g.call(this,e);var i,n,u=typeof FileReader<"u";this.stream=function(c){this._input=c,n=c.slice||c.webkitSlice||c.mozSlice,u?((i=new FileReader).onload=it(this._chunkLoaded,this),i.onerror=it(this._chunkError,this)):i=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var c=this._input,b=(this._config.chunkSize&&(b=Math.min(this._start+this._config.chunkSize,this._input.size),c=n.call(c,this._start,b)),i.readAsText(c,this._config.encoding));u||this._chunkLoaded({target:{result:b}})},this._chunkLoaded=function(c){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(c.target.result)},this._chunkError=function(){this._sendError(i.error)}}function L(e){var i;g.call(this,e=e||{}),this.stream=function(n){return i=n,this._nextChunk()},this._nextChunk=function(){var n,u;if(!this._finished)return n=this._config.chunkSize,i=n?(u=i.substring(0,n),i.substring(n)):(u=i,""),this._finished=!i,this.parseChunk(u)}}function q(e){g.call(this,e=e||{});var i=[],n=!0,u=!1;this.pause=function(){g.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){g.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(c){this._input=c,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){u&&i.length===1&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),i.length?this.parseChunk(i.shift()):n=!0},this._streamData=it(function(c){try{i.push(typeof c=="string"?c:c.toString(this._config.encoding)),n&&(n=!1,this._checkIsFinished(),this.parseChunk(i.shift()))}catch(b){this._streamError(b)}},this),this._streamError=it(function(c){this._streamCleanUp(),this._sendError(c)},this),this._streamEnd=it(function(){this._streamCleanUp(),u=!0,this._streamData("")},this),this._streamCleanUp=it(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function Z(e){var i,n,u,c,b=Math.pow(2,53),B=-b,H=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,$=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,y=this,I=0,f=0,j=!1,m=!1,x=[],d={data:[],errors:[],meta:{}};function U(w){return e.skipEmptyLines==="greedy"?w.join("").trim()==="":w.length===1&&w[0].length===0}function O(){if(d&&u&&(G("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+l.DefaultDelimiter+"'"),u=!1),e.skipEmptyLines&&(d.data=d.data.filter(function(p){return!U(p)})),X()){let p=function(M,W){D(e.transformHeader)&&(M=e.transformHeader(M,W)),x.push(M)};if(d)if(Array.isArray(d.data[0])){for(var w=0;X()&&w<d.data.length;w++)d.data[w].forEach(p);d.data.splice(0,1)}else d.data.forEach(p)}function S(p,M){for(var W=e.header?{}:[],k=0;k<p.length;k++){var C=k,E=p[k],E=((K,v)=>(F=>(e.dynamicTypingFunction&&e.dynamicTyping[F]===void 0&&(e.dynamicTyping[F]=e.dynamicTypingFunction(F)),(e.dynamicTyping[F]||e.dynamicTyping)===!0))(K)?v==="true"||v==="TRUE"||v!=="false"&&v!=="FALSE"&&((F=>{if(H.test(F)&&(F=parseFloat(F),B<F&&F<b))return 1})(v)?parseFloat(v):$.test(v)?new Date(v):v===""?null:v):v)(C=e.header?k>=x.length?"__parsed_extra":x[k]:C,E=e.transform?e.transform(E,C):E);C==="__parsed_extra"?(W[C]=W[C]||[],W[C].push(E)):W[C]=E}return e.header&&(k>x.length?G("FieldMismatch","TooManyFields","Too many fields: expected "+x.length+" fields but parsed "+k,f+M):k<x.length&&G("FieldMismatch","TooFewFields","Too few fields: expected "+x.length+" fields but parsed "+k,f+M)),W}var P;d&&(e.header||e.dynamicTyping||e.transform)&&(P=1,!d.data.length||Array.isArray(d.data[0])?(d.data=d.data.map(S),P=d.data.length):d.data=S(d.data,0),e.header&&d.meta&&(d.meta.fields=x),f+=P)}function X(){return e.header&&x.length===0}function G(w,S,P,p){w={type:w,code:S,message:P},p!==void 0&&(w.row=p),d.errors.push(w)}D(e.step)&&(c=e.step,e.step=function(w){d=w,X()?O():(O(),d.data.length!==0&&(I+=w.data.length,e.preview&&I>e.preview?n.abort():(d.data=d.data[0],c(d,y))))}),this.parse=function(w,S,P){var p=e.quoteChar||'"',p=(e.newline||(e.newline=this.guessLineEndings(w,p)),u=!1,e.delimiter?D(e.delimiter)&&(e.delimiter=e.delimiter(w),d.meta.delimiter=e.delimiter):((p=((M,W,k,C,E)=>{var K,v,F,st;E=E||[",","	","|",";",l.RECORD_SEP,l.UNIT_SEP];for(var nt=0;nt<E.length;nt++){for(var Q,at=E[nt],N=0,J=0,Y=0,V=(F=void 0,new ut({comments:C,delimiter:at,newline:W,preview:10}).parse(M)),et=0;et<V.data.length;et++)k&&U(V.data[et])?Y++:(Q=V.data[et].length,J+=Q,F===void 0?F=Q:0<Q&&(N+=Math.abs(Q-F),F=Q));0<V.data.length&&(J/=V.data.length-Y),(v===void 0||N<=v)&&(st===void 0||st<J)&&1.99<J&&(v=N,K=at,st=J)}return{successful:!!(e.delimiter=K),bestDelimiter:K}})(w,e.newline,e.skipEmptyLines,e.comments,e.delimitersToGuess)).successful?e.delimiter=p.bestDelimiter:(u=!0,e.delimiter=l.DefaultDelimiter),d.meta.delimiter=e.delimiter),dt(e));return e.preview&&e.header&&p.preview++,i=w,n=new ut(p),d=n.parse(i,S,P),O(),j?{meta:{paused:!0}}:d||{meta:{paused:!1}}},this.paused=function(){return j},this.pause=function(){j=!0,n.abort(),i=D(e.chunk)?"":i.substring(n.getCharIndex())},this.resume=function(){y.streamer._halted?(j=!1,y.streamer.parseChunk(i,!0)):setTimeout(y.resume,3)},this.aborted=function(){return m},this.abort=function(){m=!0,n.abort(),d.meta.aborted=!0,D(e.complete)&&e.complete(d),i=""},this.guessLineEndings=function(M,p){M=M.substring(0,1048576);var p=new RegExp(rt(p)+"([^]*?)"+rt(p),"gm"),P=(M=M.replace(p,"")).split("\r"),p=M.split(`
`),M=1<p.length&&p[0].length<P[0].length;if(P.length===1||M)return`
`;for(var W=0,k=0;k<P.length;k++)P[k][0]===`
`&&W++;return W>=P.length/2?`\r
`:"\r"}}function rt(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ut(e){var i=(e=e||{}).delimiter,n=e.newline,u=e.comments,c=e.step,b=e.preview,B=e.fastMode,H=null,$=!1,y=e.quoteChar==null?'"':e.quoteChar,I=y;if(e.escapeChar!==void 0&&(I=e.escapeChar),(typeof i!="string"||-1<l.BAD_DELIMITERS.indexOf(i))&&(i=","),u===i)throw new Error("Comment character same as delimiter");u===!0?u="#":(typeof u!="string"||-1<l.BAD_DELIMITERS.indexOf(u))&&(u=!1),n!==`
`&&n!=="\r"&&n!==`\r
`&&(n=`
`);var f=0,j=!1;this.parse=function(m,x,d){if(typeof m!="string")throw new Error("Input must be a string");var U=m.length,O=i.length,X=n.length,G=u.length,w=D(c),S=[],P=[],p=[],M=f=0;if(!m)return N();if(B||B!==!1&&m.indexOf(y)===-1){for(var W=m.split(n),k=0;k<W.length;k++){if(p=W[k],f+=p.length,k!==W.length-1)f+=n.length;else if(d)return N();if(!u||p.substring(0,G)!==u){if(w){if(S=[],st(p.split(i)),J(),j)return N()}else st(p.split(i));if(b&&b<=k)return S=S.slice(0,b),N(!0)}}return N()}for(var C=m.indexOf(i,f),E=m.indexOf(n,f),K=new RegExp(rt(I)+rt(y),"g"),v=m.indexOf(y,f);;)if(m[f]===y)for(v=f,f++;;){if((v=m.indexOf(y,v+1))===-1)return d||P.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:S.length,index:f}),Q();if(v===U-1)return Q(m.substring(f,v).replace(K,y));if(y===I&&m[v+1]===I)v++;else if(y===I||v===0||m[v-1]!==I){C!==-1&&C<v+1&&(C=m.indexOf(i,v+1));var F=nt((E=E!==-1&&E<v+1?m.indexOf(n,v+1):E)===-1?C:Math.min(C,E));if(m.substr(v+1+F,O)===i){p.push(m.substring(f,v).replace(K,y)),m[f=v+1+F+O]!==y&&(v=m.indexOf(y,f)),C=m.indexOf(i,f),E=m.indexOf(n,f);break}if(F=nt(E),m.substring(v+1+F,v+1+F+X)===n){if(p.push(m.substring(f,v).replace(K,y)),at(v+1+F+X),C=m.indexOf(i,f),v=m.indexOf(y,f),w&&(J(),j))return N();if(b&&S.length>=b)return N(!0);break}P.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:S.length,index:f}),v++}}else if(u&&p.length===0&&m.substring(f,f+G)===u){if(E===-1)return N();f=E+X,E=m.indexOf(n,f),C=m.indexOf(i,f)}else if(C!==-1&&(C<E||E===-1))p.push(m.substring(f,C)),f=C+O,C=m.indexOf(i,f);else{if(E===-1)break;if(p.push(m.substring(f,E)),at(E+X),w&&(J(),j))return N();if(b&&S.length>=b)return N(!0)}return Q();function st(Y){S.push(Y),M=f}function nt(Y){var V=0;return V=Y!==-1&&(Y=m.substring(v+1,Y))&&Y.trim()===""?Y.length:V}function Q(Y){return d||(Y===void 0&&(Y=m.substring(f)),p.push(Y),f=U,st(p),w&&J()),N()}function at(Y){f=Y,st(p),p=[],E=m.indexOf(n,f)}function N(Y){if(e.header&&!x&&S.length&&!$){var V=S[0],et=Object.create(null),ft=new Set(V);let vt=!1;for(let ot=0;ot<V.length;ot++){let tt=V[ot];if(et[tt=D(e.transformHeader)?e.transformHeader(tt,ot):tt]){let ht,_t=et[tt];for(;ht=tt+"_"+_t,_t++,ft.has(ht););ft.add(ht),V[ot]=ht,et[tt]++,vt=!0,(H=H===null?{}:H)[ht]=tt}else et[tt]=1,V[ot]=tt;ft.add(tt)}vt&&console.warn("Duplicate headers found and renamed."),$=!0}return{data:S,errors:P,meta:{delimiter:i,linebreak:n,aborted:j,truncated:!!Y,cursor:M+(x||0),renamedHeaders:H}}}function J(){c(N()),S=[],P=[]}},this.abort=function(){j=!0},this.getCharIndex=function(){return f}}function wt(e){var i=e.data,n=_[i.workerId],u=!1;if(i.error)n.userError(i.error,i.file);else if(i.results&&i.results.data){var c={abort:function(){u=!0,gt(i.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:mt,resume:mt};if(D(n.userStep)){for(var b=0;b<i.results.data.length&&(n.userStep({data:i.results.data[b],errors:i.results.errors,meta:i.results.meta},c),!u);b++);delete i.results}else D(n.userChunk)&&(n.userChunk(i.results,c,i.file),delete i.results)}i.finished&&!u&&gt(i.workerId,i.results)}function gt(e,i){var n=_[e];D(n.userComplete)&&n.userComplete(i),n.terminate(),delete _[e]}function mt(){throw new Error("Not implemented.")}function dt(e){if(typeof e!="object"||e===null)return e;var i,n=Array.isArray(e)?[]:{};for(i in e)n[i]=dt(e[i]);return n}function it(e,i){return function(){e.apply(i,arguments)}}function D(e){return typeof e=="function"}return l.parse=function(e,i){var n=(i=i||{}).dynamicTyping||!1;if(D(n)&&(i.dynamicTypingFunction=n,n={}),i.dynamicTyping=n,i.transform=!!D(i.transform)&&i.transform,!i.worker||!l.WORKERS_SUPPORTED)return n=null,l.NODE_STREAM_INPUT,typeof e=="string"?(e=(u=>u.charCodeAt(0)!==65279?u:u.slice(1))(e),n=new(i.download?R:L)(i)):e.readable===!0&&D(e.read)&&D(e.on)?n=new q(i):(s.File&&e instanceof File||e instanceof Object)&&(n=new A(i)),n.stream(e);(n=(()=>{var u;return!!l.WORKERS_SUPPORTED&&(u=(()=>{var c=s.URL||s.webkitURL||null,b=r.toString();return l.BLOB_URL||(l.BLOB_URL=c.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",b,")();"],{type:"text/javascript"})))})(),(u=new s.Worker(u)).onmessage=wt,u.id=T++,_[u.id]=u)})()).userStep=i.step,n.userChunk=i.chunk,n.userComplete=i.complete,n.userError=i.error,i.step=D(i.step),i.chunk=D(i.chunk),i.complete=D(i.complete),i.error=D(i.error),delete i.worker,n.postMessage({input:e,config:i,workerId:n.id})},l.unparse=function(e,i){var n=!1,u=!0,c=",",b=`\r
`,B='"',H=B+B,$=!1,y=null,I=!1,f=((()=>{if(typeof i=="object"){if(typeof i.delimiter!="string"||l.BAD_DELIMITERS.filter(function(x){return i.delimiter.indexOf(x)!==-1}).length||(c=i.delimiter),typeof i.quotes!="boolean"&&typeof i.quotes!="function"&&!Array.isArray(i.quotes)||(n=i.quotes),typeof i.skipEmptyLines!="boolean"&&typeof i.skipEmptyLines!="string"||($=i.skipEmptyLines),typeof i.newline=="string"&&(b=i.newline),typeof i.quoteChar=="string"&&(B=i.quoteChar),typeof i.header=="boolean"&&(u=i.header),Array.isArray(i.columns)){if(i.columns.length===0)throw new Error("Option columns is empty");y=i.columns}i.escapeChar!==void 0&&(H=i.escapeChar+B),i.escapeFormulae instanceof RegExp?I=i.escapeFormulae:typeof i.escapeFormulae=="boolean"&&i.escapeFormulae&&(I=/^[=+\-@\t\r].*$/)}})(),new RegExp(rt(B),"g"));if(typeof e=="string"&&(e=JSON.parse(e)),Array.isArray(e)){if(!e.length||Array.isArray(e[0]))return j(null,e,$);if(typeof e[0]=="object")return j(y||Object.keys(e[0]),e,$)}else if(typeof e=="object")return typeof e.data=="string"&&(e.data=JSON.parse(e.data)),Array.isArray(e.data)&&(e.fields||(e.fields=e.meta&&e.meta.fields||y),e.fields||(e.fields=Array.isArray(e.data[0])?e.fields:typeof e.data[0]=="object"?Object.keys(e.data[0]):[]),Array.isArray(e.data[0])||typeof e.data[0]=="object"||(e.data=[e.data])),j(e.fields||[],e.data||[],$);throw new Error("Unable to serialize unrecognized input");function j(x,d,U){var O="",X=(typeof x=="string"&&(x=JSON.parse(x)),typeof d=="string"&&(d=JSON.parse(d)),Array.isArray(x)&&0<x.length),G=!Array.isArray(d[0]);if(X&&u){for(var w=0;w<x.length;w++)0<w&&(O+=c),O+=m(x[w],w);0<d.length&&(O+=b)}for(var S=0;S<d.length;S++){var P=(X?x:d[S]).length,p=!1,M=X?Object.keys(d[S]).length===0:d[S].length===0;if(U&&!X&&(p=U==="greedy"?d[S].join("").trim()==="":d[S].length===1&&d[S][0].length===0),U==="greedy"&&X){for(var W=[],k=0;k<P;k++){var C=G?x[k]:k;W.push(d[S][C])}p=W.join("").trim()===""}if(!p){for(var E=0;E<P;E++){0<E&&!M&&(O+=c);var K=X&&G?x[E]:E;O+=m(d[S][K],E)}S<d.length-1&&(!U||0<P&&!M)&&(O+=b)}}return O}function m(x,d){var U,O;return x==null?"":x.constructor===Date?JSON.stringify(x).slice(1,25):(O=!1,I&&typeof x=="string"&&I.test(x)&&(x="'"+x,O=!0),U=x.toString().replace(f,H),(O=O||n===!0||typeof n=="function"&&n(x,d)||Array.isArray(n)&&n[d]||((X,G)=>{for(var w=0;w<G.length;w++)if(-1<X.indexOf(G[w]))return!0;return!1})(U,l.BAD_DELIMITERS)||-1<U.indexOf(c)||U.charAt(0)===" "||U.charAt(U.length-1)===" ")?B+U+B:U)}},l.RECORD_SEP="",l.UNIT_SEP="",l.BYTE_ORDER_MARK="\uFEFF",l.BAD_DELIMITERS=["\r",`
`,'"',l.BYTE_ORDER_MARK],l.WORKERS_SUPPORTED=!a&&!!s.Worker,l.NODE_STREAM_INPUT=1,l.LocalChunkSize=10485760,l.RemoteChunkSize=5242880,l.DefaultDelimiter=",",l.Parser=ut,l.ParserHandle=Z,l.NetworkStreamer=R,l.FileStreamer=A,l.StringStreamer=L,l.ReadableStreamStreamer=q,s.jQuery&&((o=s.jQuery).fn.parse=function(e){var i=e.config||{},n=[];return this.each(function(b){if(!(o(this).prop("tagName").toUpperCase()==="INPUT"&&o(this).attr("type").toLowerCase()==="file"&&s.FileReader)||!this.files||this.files.length===0)return!0;for(var B=0;B<this.files.length;B++)n.push({file:this.files[B],inputElem:this,instanceConfig:o.extend({},i)})}),u(),this;function u(){if(n.length===0)D(e.complete)&&e.complete();else{var b,B,H,$,y=n[0];if(D(e.before)){var I=e.before(y.file,y.inputElem);if(typeof I=="object"){if(I.action==="abort")return b="AbortError",B=y.file,H=y.inputElem,$=I.reason,void(D(e.error)&&e.error({name:b},B,H,$));if(I.action==="skip")return void c();typeof I.config=="object"&&(y.instanceConfig=o.extend(y.instanceConfig,I.config))}else if(I==="skip")return void c()}var f=y.instanceConfig.complete;y.instanceConfig.complete=function(j){D(f)&&f(j,y.file,y.inputElem),c()},l.parse(y.file,y.instanceConfig)}}function c(){n.splice(0,1),u()}}),h&&(s.onmessage=function(e){e=e.data,l.WORKER_ID===void 0&&e&&(l.WORKER_ID=e.workerId),typeof e.input=="string"?s.postMessage({workerId:l.WORKER_ID,results:l.parse(e.input,e.config),finished:!0}):(s.File&&e.input instanceof File||e.input instanceof Object)&&(e=l.parse(e.input,e.config))&&s.postMessage({workerId:l.WORKER_ID,results:e,finished:!0})}),(R.prototype=Object.create(g.prototype)).constructor=R,(A.prototype=Object.create(g.prototype)).constructor=A,(L.prototype=Object.create(L.prototype)).constructor=L,(q.prototype=Object.create(g.prototype)).constructor=q,l})}(lt)),lt.exports}var Lt=Ct();const zt=kt(Lt),ct=class ct{async loadCSV(t,r){const s=t.split(","),o=s.length;let a=[];for(let h=0;h<o;h++){const _=await this.loadSingleCSV(s[h],T=>{r(Math.floor((h+T/100)/o*100))});a=a.concat(_)}return a}async loadSingleCSV(t,r){const s=await fetch(t),o=t.split("/").pop(),a=ct.FILE_SIZES[o],h=s.body.getReader();let _=0;const T=[];for(;;){const{done:R,value:A}=await h.read();if(R)break;T.push(A),a&&r&&(_+=A.length,r(_/a*100))}const g=await new Blob(T).text();return new Promise((R,A)=>{zt.parse(g,{header:!0,dynamicTyping:!1,skipEmptyLines:!0,complete:L=>{!L.data||L.data.length===0?A(new Error("CSV file contains no data")):R(L.data)},error:L=>A(L)})})}processData(t){const r=["id","title","x","y","size","r","g","b"],s=t[0];for(const g of r)if(!(g in s))throw new Error(`CSV is missing required field: ${g}`);const o=t.length,a=new Float32Array(o*2),h=new Float32Array(o),_=new Float32Array(o*4),T=new Array(o),l=new Array(o);for(let g=0;g<o;g++){const R=t[g];a[g*2]=parseFloat(R.x),a[g*2+1]=parseFloat(R.y),h[g]=parseFloat(R.size),_[g*4]=parseFloat(R.r),_[g*4+1]=parseFloat(R.g),_[g*4+2]=parseFloat(R.b),_[g*4+3]=1,T[g]=R.title,l[g]=parseInt(R.id)}return{numItems:o,offsets:a,sizes:h,colors:_,titles:T,ids:l}}};bt(ct,"FILE_SIZES",{"layout60k-Sep-10-2024.csv":6792224,"layout500k-Sep-10-2024.csv":57693366,"layout1m-part1-Sep-10-2024.csv":59988553,"layout1m-part2-Sep-10-2024.csv":56877942});let pt=ct;class Ft{constructor(t,r){this.visualization=t,this.controls=r,this.searchInput=document.getElementById("search"),this.resultsContainer=document.getElementById("search-results"),this.loadingIndicator=document.querySelector(".search-loading"),this.searchButton=document.getElementById("search-button"),this.isDataInitialized=!1,this.searchWorker=new Worker(new URL("/Map-of-Wiki/assets/searchWorker-Bc43q3xj.js",import.meta.url),{type:"module"}),this.searchWorker.onmessage=s=>this.handleWorkerMessage(s),this.searchButton.addEventListener("click",()=>this.performSearch()),this.searchInput.addEventListener("input",()=>this.clearResults())}showLoading(t){this.loadingIndicator&&(this.loadingIndicator.style.display=t?"block":"none")}async performSearch(){const t=this.searchInput.value.trim();if(!t){this.clearResults();return}this.showLoading(!0),this.isDataInitialized||(this.searchWorker.postMessage({query:t,titles:this.visualization.processedData.titles,options:{limit:5,threshold:-1e4}}),this.isDataInitialized=!0),this.searchWorker.postMessage({query:t,titles:null,options:{limit:5,threshold:-1e4}})}handleWorkerMessage(t){const{results:r}=t.data;this.displayResults(r),this.showLoading(!1)}displayResults(t){if(t.length===0){this.resultsContainer.innerHTML='<div class="search-result-empty">No results found</div>',this.resultsContainer.style.display="block";return}this.resultsContainer.innerHTML=t.map(r=>`<div class="search-result-item" data-title="${r.target}">${r.target}</div>`).join(""),this.resultsContainer.style.display="block",this.resultsContainer.querySelectorAll(".search-result-item").forEach(r=>{r.addEventListener("click",s=>this.handleResultClick(s))})}handleResultClick(t){const r=t.target.closest(".search-result-item").dataset.title;this.clearSearch(),this.handleSearchResult(r)}handleSearchResult(t){const r=this.visualization.processedData.titles.indexOf(t);if(r===-1)return;const s=this.visualization.processedData.offsets[r*2],o=this.visualization.processedData.offsets[r*2+1],a=this.visualization.processedData.sizes[r]*5;this.controls.smoothTransition(s,o,a,!0)}clearSearch(){this.searchInput.value="",this.clearResults(),this.showLoading(!1)}clearResults(){this.resultsContainer.innerHTML="",this.resultsContainer.style.display="none"}destroy(){this.searchWorker&&this.searchWorker.terminate()}}class It{constructor(t,r){this.zoomLevel=1,this.cameraX=0,this.cameraY=0,this.isDragging=!1,this.wasDragging=!1,this.lastMouseX=0,this.lastMouseY=0,this.transitionActive=!1,this.startState=null,this.endState=null,this.midState=null,this.stageCount=0,this.stage=0,this.stage1Duration=2e3,this.stage2Duration=2e3,this.transitionStartTime=0,this.wheelSensitivity=.002,this.touchSensitivity=.004,this.lastTouchDistance=null,this.canvas=t,this.visualization=r,this.canvas.addEventListener("mousedown",s=>this.handleMouseDown(s)),this.canvas.addEventListener("touchstart",s=>this.handleTouchStart(s),{passive:!1}),this.canvas.addEventListener("mouseup",()=>this.handleMouseUp()),this.canvas.addEventListener("mouseleave",()=>this.handleMouseUp()),this.canvas.addEventListener("touchend",()=>this.isDragging=!1),this.canvas.addEventListener("mousemove",s=>this.handleMouseMove(s)),this.canvas.addEventListener("touchmove",s=>this.handleTouchMove(s),{passive:!1}),this.canvas.addEventListener("wheel",s=>this.handleZoom(s),{passive:!0}),this.canvas.addEventListener("click",s=>{this.wasDragging||this.clickArticle(s),this.wasDragging=!1}),document.getElementById("random-button").addEventListener("click",()=>this.goToRandomArticle())}handleMouseDown(t){this.transitionActive||(this.isDragging=!0,this.lastMouseX=t.clientX,this.lastMouseY=t.clientY)}handleMouseUp(){this.isDragging=!1}handleMouseMove(t){!this.isDragging||this.transitionActive||(this.wasDragging=!0,this.updateCameraPosition(t.clientX,t.clientY))}handleTouchStart(t){if(!this.transitionActive){if(t.touches.length===2){t.preventDefault(),this.lastTouchDistance=this.getTouchDistance(t.touches);return}t.touches.length===1&&(t.preventDefault(),this.isDragging=!0,this.lastMouseX=t.touches[0].clientX,this.lastMouseY=t.touches[0].clientY)}}handleTouchMove(t){if(!this.transitionActive){if(t.touches.length===2){t.preventDefault();const r=this.getTouchDistance(t.touches),s=(t.touches[0].clientX+t.touches[1].clientX)/2,o=(t.touches[0].clientY+t.touches[1].clientY)/2,a=r/this.lastTouchDistance,h=this.screenToWorld(s,o);this.zoomLevel*=1/a;const _=this.screenToWorld(s,o);this.cameraX+=h.x-_.x,this.cameraY+=h.y-_.y,this.lastTouchDistance=r;return}!this.isDragging||t.touches.length!==1||(t.preventDefault(),this.wasDragging=!0,this.updateCameraPosition(t.touches[0].clientX,t.touches[0].clientY))}}getTouchDistance(t){const r=t[0].clientX-t[1].clientX,s=t[0].clientY-t[1].clientY;return Math.hypot(r,s)}handleZoom(t){if(this.transitionActive)return;const s=Number.isInteger(t.deltaY)&&t.deltaX===0?this.wheelSensitivity:this.touchSensitivity,o=Math.exp(t.deltaY*s),a=this.screenToWorld(t.clientX,t.clientY);this.zoomLevel*=o;const h=this.screenToWorld(t.clientX,t.clientY);this.cameraX+=a.x-h.x,this.cameraY+=a.y-h.y}screenToWorld(t,r){const s=this.canvas.getBoundingClientRect(),o=s.width,a=s.height,h=(t-s.left)/o,_=(r-s.top)/a,T=h*2-1,l=-(_*2-1),g=o/a,R=this.cameraX+T*this.zoomLevel*g,A=this.cameraY+l*this.zoomLevel;return{x:R,y:A}}updateCameraPosition(t,r){const s=this.screenToWorld(this.lastMouseX,this.lastMouseY),o=this.screenToWorld(t,r);this.cameraX+=s.x-o.x,this.cameraY+=s.y-o.y,this.lastMouseX=t,this.lastMouseY=r}smoothTransition(t,r,s,o){if(this.transitionActive=!0,this.startState={x:this.cameraX,y:this.cameraY,zoom:this.zoomLevel},this.endState={x:t,y:r,zoom:s},this.stage1Duration=2e3,this.stage2Duration=2e3,o===!1)this.stageCount=1;else{const a=this.endState.x-this.startState.x,h=this.endState.y-this.startState.y,_=Math.hypot(a,h),T=Math.max(this.startState.zoom,_*.8);this.midState={x:this.cameraX,y:this.cameraY,zoom:T},this.stageCount=2,this.stage=0,this.zoomLevel===T&&(this.stage1Duration=0)}this.transitionStartTime=performance.now()}updateTransition(t){const r=t-this.transitionStartTime;let s;this.stageCount===1?s=this.stage1Duration:this.stage===0?s=this.stage1Duration:s=this.stage2Duration;const o=Math.min(r/s,1),a=o<.5?2*o*o:1-Math.pow(-2*o+2,2)/2;if(this.stageCount===1)this.zoomLevel=this.startState.zoom+(this.endState.zoom-this.startState.zoom)*a,o>=1&&(this.cameraX=this.endState.x,this.cameraY=this.endState.y,this.transitionActive=!1);else if(this.stageCount===2&&this.stage===0)this.zoomLevel=this.startState.zoom+(this.midState.zoom-this.startState.zoom)*a,o>=1&&(this.stage=1,this.transitionStartTime=t);else if(this.stageCount===2&&this.stage===1){const h=this.midState,_=this.endState;this.cameraX=h.x+(_.x-h.x)*a,this.cameraY=h.y+(_.y-h.y)*a,this.zoomLevel=h.zoom+(_.zoom-h.zoom)*a,o>=1&&(this.transitionActive=!1)}}reset(){this.cameraX=0,this.cameraY=0,this.zoomLevel=1,this.smoothTransition(0,0,60,!1)}clickArticle(t){const r=this.screenToWorld(t.clientX,t.clientY);console.log("cursor",r);const{offsets:s,sizes:o,ids:a,titles:h,numItems:_}=this.visualization.processedData;for(let T=0;T<_;T++){const l=s[T*2],g=s[T*2+1],R=o[T],A=r.x-l,L=r.y-g;if(Math.sqrt(A*A+L*L)<=R){const Z=a[T],rt=h[T];console.log(l,g,R),console.log(`Clicked on article: ${rt} (ID: ${Z})`),this.showEmbeddedWikiArticle(Z);return}}}showEmbeddedWikiArticle(t){const r=document.getElementById("wiki-embed-container"),s=document.getElementById("wiki-iframe"),o=document.getElementById("close-wiki-btn"),a=`https://en.wikipedia.org/?curid=${t}`;s.src=a,r.classList.add("active"),this._outsideClickHandler||(this._outsideClickHandler=h=>{!r.contains(h.target)&&r.classList.contains("active")&&!h.target.closest("#webgl-canvas")&&o.click()}),o.onclick=()=>{r.classList.remove("active"),document.removeEventListener("click",this._outsideClickHandler),setTimeout(()=>{s.src="about:blank"},300)},document.addEventListener("click",this._outsideClickHandler)}goToRandomArticle(){const t=Math.floor(Math.random()*this.visualization.processedData.numItems),r=this.visualization.processedData.offsets[t*2],s=this.visualization.processedData.offsets[t*2+1],o=this.visualization.processedData.sizes[t]*5;this.smoothTransition(r,s,o,!0)}}class Pt{constructor(){this.canvas=document.getElementById("webgl-canvas"),this.webgl=new Rt(this.canvas),this.textRenderer=new Tt(this.webgl.gl),this.circleRenderer=new St(this.webgl.gl),this.controls=new It(this.canvas,this),this.DataLoader=new pt,this.searchManager=new Ft(this,this.controls),this.processedData=null,this.animationFrameId=null,this.initializing=!1,this.lastTextUpdateTime=0,this.textUpdateInterval=1e3,this.fpsCounter=document.getElementById("fps-counter"),this.pctEl=document.getElementById("loading-percent"),this.lastFrameTime=0,this.frameCount=0,this.lastFpsUpdate=0,this.fps=0,document.getElementById("load-button").addEventListener("click",()=>this.initialize()),this.setupIntroOverlay()}setupIntroOverlay(){const t=document.getElementById("intro-overlay"),r=document.getElementById("start-exploration"),s=document.getElementById("csv-select");r.addEventListener("click",()=>{const o=document.querySelector('input[name="dataset"]:checked').value;s.value=o,t.style.display="none",this.initialize()})}async initialize(){if(this.initializing)return;this.initializing=!0;const r=document.getElementById("csv-select").value;this.showLoadingIndicator(!0);const s=await this.DataLoader.loadCSV(r,o=>{this.pctEl.textContent=`${Math.floor(o)}%`});console.log(`Loaded ${s.length} data points from CSV`),this.processedData=this.DataLoader.processData(s),console.log(`Processed data: ${this.processedData.numItems} items`),this.circleRenderer.setData(this.processedData),await this.textRenderer.loadFont(),this.updateVisibleText(),this.controls.reset(),this.animationFrameId||this.startRenderLoop(),this.showLoadingIndicator(!1),this.initializing=!1}startRenderLoop(){this.lastFrameTime=performance.now(),this.lastFpsUpdate=this.lastFrameTime,this.frameCount=0,this.animationFrameId=requestAnimationFrame(t=>this.draw(t))}showLoadingIndicator(t){const r=document.getElementById("loading");r.style.display=t?"flex":"none"}updateFpsCounter(t){this.frameCount++,t-this.lastFpsUpdate>=500&&(this.fps=Math.round(this.frameCount*1e3/(t-this.lastFpsUpdate)),this.fpsCounter&&(this.fpsCounter.textContent=`${this.fps} FPS`),this.lastFpsUpdate=t,this.frameCount=0)}updateVisibleText(){const t=this.controls.screenToWorld(0,0),r=this.controls.screenToWorld(this.canvas.width,this.canvas.height),s={minX:Math.min(t.x,r.x),maxX:Math.max(t.x,r.x),minY:Math.min(t.y,r.y),maxY:Math.max(t.y,r.y)};if((s.maxX-s.minX)*(s.maxY-s.minY)>3e3)return;const a=[],{offsets:h,sizes:_,titles:T,numItems:l}=this.processedData;for(let A=0;A<l;A++){const L=h[A*2],q=h[A*2+1];L>=s.minX&&L<=s.maxX&&q>=s.minY&&q<=s.maxY&&a.push({text:T[A],x:L,y:q,limit:2*_[A],cx:.51,cy:.5,radius:_[A]})}const g=1e3;let R=a;a.length>g&&(R=a.sort((A,L)=>L.radius-A.radius).slice(0,g)),console.log(`Showing ${R.length} labels out of ${a.length} visible circles`),this.textRenderer.batchAddText(R)}draw(t){this.webgl.clear(),this.webgl.resizeCanvas(),this.updateFpsCounter(t),this.controls.transitionActive&&this.controls.updateTransition(t),t-this.lastTextUpdateTime>this.textUpdateInterval&&(this.updateVisibleText(),this.lastTextUpdateTime=t);const r=this.webgl.createProjectionMatrix(this.controls.cameraX,this.controls.cameraY,this.controls.zoomLevel);this.circleRenderer.draw(r,this.controls.zoomLevel),this.textRenderer.draw(r),this.animationFrameId=requestAnimationFrame(s=>this.draw(s))}}try{new Pt}catch(z){console.error("Failed to initialize application:",z),alert("Failed to initialize the application. See console for details.")}
